# 多实例测试指南

## 概述

现在应用支持同时运行多个实例进行测试，这对于测试同步功能、局域网同步等功能非常有用。

## 功能特性

- ✅ 每个实例使用不同的端口（避免冲突）
  - 实例 1: TCP 8765, UDP 8766
  - 实例 2: TCP 8775, UDP 8776
  - 实例 3: TCP 8785, UDP 8786（以此类推）
- ✅ 共享同一个数据库（可以测试数据同步）
- ✅ 可以测试局域网设备发现和同步

## 使用方法

### 方法 1: 使用 PowerShell 脚本（推荐）

1. **启动第一个实例**：
   ```powershell
   .\start-instance1.ps1
   ```

2. **在新的终端窗口启动第二个实例**：
   ```powershell
   .\start-instance2.ps1
   ```

### 方法 2: 使用 npm 脚本

1. **启动第一个实例**：
   ```powershell
   npm run dev:instance1
   ```

2. **在新的终端窗口启动第二个实例**：
   ```powershell
   npm run dev:instance2
   ```

### 方法 3: 手动设置环境变量

1. **第一个终端**：
   ```powershell
   $env:INSTANCE_ID = "1"
   npm run dev
   ```

2. **第二个终端**：
   ```powershell
   $env:INSTANCE_ID = "2"
   npm run dev
   ```

## 测试场景

### 1. 局域网同步测试
- 两个实例应该能够互相发现（通过 UDP 广播）
- 可以在两个实例之间进行数据同步

### 2. 数据冲突测试
- 在两个实例中同时修改相同的数据
- 测试冲突解决机制

### 3. 云端同步测试
- 两个实例都可以连接到云端服务器
- 测试多设备同步场景

## 注意事项

1. **数据库共享**：两个实例共享同一个数据库文件，SQLite 支持并发读取，但写入时可能会有锁等待。

2. **端口冲突**：如果端口被占用，同步服务会自动尝试备用端口。

3. **Vite 开发服务器**：两个实例会尝试使用相同的 Vite 端口（5173），第二个实例会自动使用 5174。

4. **WebSocket 连接**：每个实例都会尝试连接到云端 WebSocket，这是正常的。

## 故障排除

### 端口被占用
如果看到端口冲突错误，可以：
- 检查是否有其他应用占用端口
- 使用 `netstat -ano | findstr "8765"` 查看端口使用情况

### 数据库锁定
如果遇到数据库锁定错误：
- 这是正常的，SQLite 会等待锁释放
- 如果长时间锁定，检查是否有实例异常退出

### 实例无法发现
如果两个实例无法互相发现：
- 检查防火墙设置
- 确保两个实例在同一网络
- 查看控制台日志中的 UDP 广播消息

## 开发模式 vs 生产模式

- **开发模式**：允许多实例（用于测试）
- **生产模式**：默认单实例（使用 `app.requestSingleInstanceLock()`）

要强制允许多实例，设置环境变量：
```powershell
$env:ALLOW_MULTIPLE_INSTANCES = "true"
```

